#!/bin/bash
set -euo pipefail

set -a
source /etc/dineritos-backup.env
set +a

TIMESTAMP=$(date +%Y-%m-%d_%H%M)
DUMP_FILE="dineritos-${TIMESTAMP}.dump"

trap 'rm -f "/tmp/${DUMP_FILE}"' EXIT

echo "[$(date)] Starting backup..."

docker exec dineritos-db pg_dump -Fc -U dineritos dineritos_production > "/tmp/${DUMP_FILE}"

aws s3 cp "/tmp/${DUMP_FILE}" "s3://${B2_BUCKET}/daily/${DUMP_FILE}"

echo "[$(date)] Backup complete: ${DUMP_FILE}"
