#!/bin/bash
set -e

REMOTE_DUMP="latest.dump"
LOCAL_FILE=~/Downloads/dineritos-backup-$(date +%Y-%m-%d).dump
DROPLET_IP=$(ruby -ryaml -e "puts YAML.safe_load_file('config/deploy.yml', aliases: true)['servers']['web']['hosts'].first")

echo "Creating database dump on production..."
kamal db-dump

echo "Copying dump from container to host..."
ssh root@$DROPLET_IP "docker cp dineritos-db:/tmp/$REMOTE_DUMP /tmp/$REMOTE_DUMP"

echo "Downloading dump..."
scp root@$DROPLET_IP:/tmp/$REMOTE_DUMP "$LOCAL_FILE"

# Cleanup remote files
ssh root@$DROPLET_IP "rm /tmp/$REMOTE_DUMP && docker exec dineritos-db rm /tmp/$REMOTE_DUMP"
echo "Done! Saved to $LOCAL_FILE"
